# üõ°Ô∏è DevSecOps CI Pipeline: OWASP Juice Shop Security Scanning with Jenkins

This project demonstrates a complete **DevSecOps CI pipeline** using Jenkins to perform security scans on the popular vulnerable web application ‚Äì [OWASP Juice Shop](https://github.com/juice-shop/juice-shop). The pipeline integrates **SAST tools** to automatically detect secrets, insecure code patterns, and vulnerable dependencies, and sends the results to **DefectDojo**, a security orchestration and vulnerability management platform.

[![Branch: Jenkinsfile](https://img.shields.io/badge/branch-Jenkinsfile-blue)](https://github.com/DanielAzeez/Jenkins-Pipeline-for-OWASP-juice-shop/blob/Jenkinsfile/Jenkinsfile)

---

## üöÄ Project Goals

- Fork and clone the OWASP Juice Shop repository
- Set up a Jenkins CI pipeline 
- Perform Static Application Security Testing (SAST) with:
  - **Gitleaks** for secret detection
  - **Semgrep** for static code analysis
  - **NJSSCAN** for scanning Node.js dependencies
- Generate reports in **JSON** formats
- Automatically upload scan results to **DefectDojo** using its REST API

---

---
## Prerequisites

#### Before running this pipeline, ensure that you have the following set up:

- Jenkins installed and running: You can download and set it up from https://www.jenkins.io/.
- Semgrep App Token: Sign up and obtain your token at https://semgrep.dev/.
- DefectDojo API Token: Use the public demo instance at https://demo.defectdojo.org or set up your own DefectDojo instance and generate an API token.

#### Make sure these credentials are securely stored in Jenkins credentials manager or referenced via environment variables in your pipeline.
---

## üîç What is OWASP Juice Shop?

[OWASP Juice Shop](https://github.com/juice-shop/juice-shop) is an intentionally insecure web application designed for security training and awareness. It includes a wide range of vulnerabilities and is used widely by ethical hackers and security professionals for testing security tools and techniques.

---

## üõ†Ô∏è Tools Used

### üîê Gitleaks
- **Purpose**: Scans the repository for hardcoded secrets (e.g., API keys, passwords, tokens).
- **Output**: `gitleaks-report.json`
- **Format**: JSON
- **Why it's important**: Secrets should never be committed to version control. Gitleaks ensures no sensitive credentials are leaked.

### üß† Semgrep
- **Purpose**: Performs static code analysis using pre-defined or custom rules to identify vulnerabilities like command injections, insecure regex, hardcoded credentials, etc.
- **Output**: `semgrep-report.json`
- **Format**: JSON
- **Why it's important**: Semgrep checks for insecure patterns in code logic across multiple languages.

### üîé NJSSCAN (Node.js Scan)
- **Purpose**: Scans Node.js applications for known vulnerable dependencies (like `npm audit` but more customizable).
- **Output**: `njsscan-output.json`
- **Format**: JSON
- **Why it's important**: Modern apps heavily rely on third-party packages. NJSSCAN checks for CVEs and outdated or dangerous packages.

---

## üì¶ DefectDojo

[DefectDojo](https://defectdojo.org/) is an open-source vulnerability management system. It helps organize, track, and manage vulnerabilities detected across your environments and tools. Its dashboard can be accessed at (https://demo.defectdojo.org).

In this project, scan reports generated by Gitleaks, Semgrep, and NJSSCAN are uploaded to DefectDojo programmatically using its API. 

---

## ‚öôÔ∏è Jenkinsfile Breakdown

```groovy
pipeline {
    agent any 
    
    environment {
        SEMGREP_APP_TOKEN = credentials('Semgrep-app')
        DEFECTDOJO_API_KEY = credentials('DEFECTDOJO_API_KEY')
        DEFECTDOJO_URL = 'https://demo.defectdojo.org'
        ENGAGEMENT_ID = '25'
    }
        
    stages {
        stage ('Run GitLeaks Scan on Code') {
            steps {
                sh '''
                REPORT_DIR="reports"
                mkdir -p "${REPORT_DIR}"
                /usr/local/bin/docker pull zricethezav/gitleaks:latest
                
                set +e
                /usr/local/bin/docker run --rm \
                    -v "${WORKSPACE}:/OWASP" \
                    zricethezav/gitleaks:latest detect --source=/OWASP \
                    --report-path=/OWASP/$REPORT_DIR/gitleaks-report.json \
                    --report-format=json 
                EXIT_CODE=$?
                set -e
                
                if [ "$EXIT_CODE" -ne 0 ]; then
                    echo "GitLeaks scan detected secrets. Please review gitleaks-report.json"
                else
                    echo "GitLeaks scan passed with no secrets detected."
                fi
                '''
            }
        }

        stage ('Static Code Analysis with Semgrep') {
            environment {
                SEMGREP_APP_TOKEN = credentials('Semgrep-app')
            }
            steps {
                sh '''
                REPORT_DIR="reports"
                mkdir -p "$REPORT_DIR"
                /usr/local/bin/docker pull semgrep/semgrep:latest
                /usr/local/bin/docker run \
                    -e SEMGREP_APP_TOKEN="$SEMGREP_APP_TOKEN" \
                    --rm -v "${WORKSPACE}:/src" semgrep/semgrep semgrep ci \
                    --json --output /src/$REPORT_DIR/semgrep-report.json
                '''
            }
        }

        stage ('Code Analysis with NJSSCAN') {
            steps {
                sh '''
                REPORT_DIR="reports"
                mkdir -p "$REPORT_DIR"
                /usr/local/bin/docker pull opensecurity/njsscan
                /usr/local/bin/docker run --rm -v "${WORKSPACE}:/src" opensecurity/njsscan /src --json | tee "$REPORT_DIR/njsscan-output.json"
                '''
            }
        }

        stage ('Upload Scan results to DefectDojo') {
            steps {
                sh '''
                echo "Uploading Gitleaks report to DefectDojo..."
                curl -X POST "$DEFECTDOJO_URL/api/v2/import-scan/" \
                    -H "Authorization: Token $DEFECTDOJO_API_KEY" \
                    -F "engagement=$ENGAGEMENT_ID" \
                    -F "scan_type=Gitleaks Scan" \
                    -F "file=@${WORKSPACE}/reports/gitleaks-report.json" \
                    -F "active=true" -F "verified=false"

                echo "Uploading Semgrep report to DefectDojo..."
                curl -X POST "$DEFECTDOJO_URL/api/v2/import-scan/" \
                    -H "Authorization: Token $DEFECTDOJO_API_KEY" \
                    -F "engagement=$ENGAGEMENT_ID" \
                    -F "scan_type=Semgrep JSON Report" \
                    -F "file=@${WORKSPACE}/reports/semgrep-report.json" \
                    -F "active=true" -F "verified=false"
                
                echo "Uploading NJSSCAN report to DefectDojo..."
                curl -X POST "$DEFECTDOJO_URL/api/v2/import-scan/" \
                    -H "Authorization: Token $DEFECTDOJO_API_KEY" \
                    -F "engagement=$ENGAGEMENT_ID" \
                    -F "scan_type=Node Security Platform Scan" \
                    -F "file=@${WORKSPACE}/reports/njsscan-output.json" \
                    -F "active=true" -F "verified=false"
                '''
            }
        }
    }

    post {
        always {
            archiveArtifacts artifacts: 'reports/*json', fingerprint: true, allowEmptyArchive: true
        }
    }
}
```

Below is a **detailed explanation** of the Jenkins pipeline used in this project.

### üåê Pipeline Configuration

```groovy
pipeline {
    agent any
````

* The pipeline can run on any available Jenkins agent.

### üîê Environment Variables

```groovy
environment {
    SEMGREP_APP_TOKEN = credentials('Semgrep-app')
    DEFECTDOJO_API_KEY = credentials('DEFECTDOJO_API_KEY')
    DEFECTDOJO_URL = 'https://demo.defectdojo.org'
    ENGAGEMENT_ID = '25'
}
```

* `SEMGREP_APP_TOKEN`: Authentication token for Semgrep CI scanning.
* `DEFECTDOJO_API_KEY`: API token to upload scans to DefectDojo.
* `DEFECTDOJO_URL`: URL of the DefectDojo instance.
* `ENGAGEMENT_ID`: The engagement ID in DefectDojo where the scan results will be attached.

---

## üîÑ Pipeline Stages

### 1Ô∏è‚É£ **Run GitLeaks Scan**

```groovy
stage ('Run GitLeaks Scan on Code') {
    steps {
        sh '''
        REPORT_DIR="reports"
        mkdir -p "${REPORT_DIR}"
        docker pull zricethezav/gitleaks:latest
        
        set +e
        docker run --rm \
            -v "${WORKSPACE}:/OWASP" \
            zricethezav/gitleaks:latest detect --source=/OWASP \
            --report-path=gitleaks-report.json \
            --report-format=json 
        EXIT_CODE=$?
        set -e
        ...
        '''
    }
}
```

* Creates a `reports/` directory to store output files.
* Pulls the latest Gitleaks Docker image.
* Mounts the workspace inside the container to scan it.
* Runs Gitleaks and outputs the results in JSON.
* Uses `set +e` so the pipeline continues even if secrets are found (to allow full scan and upload).

---

### 2Ô∏è‚É£ **Static Code Analysis with Semgrep**

```groovy
stage ('Static Code Analysis with Semgrep') {
    steps {
        sh '''
        REPORT_DIR="reports"
        mkdir -p "$REPORT_DIR"
        docker pull semgrep/semgrep:latest
        docker run \
            -e SEMGREP_APP_TOKEN="$SEMGREP_APP_TOKEN" \
            --rm -v "${WORKSPACE}:/src" semgrep/semgrep semgrep ci \
            --json --output /src/$REPORT_DIR/semgrep-report.json
        '''
    }
}
```

* Pulls Semgrep image.
* Authenticates using the provided token.
* Runs Semgrep with default or organization rulesets.
* Outputs structured results in JSON to `reports/semgrep-report.json`.

---

### 3Ô∏è‚É£ **Code Analysis with NJSSCAN**

```groovy
stage ('Code Analysis with NJSSCAN') {
    steps {
        sh '''
        REPORT_DIR="reports"
        mkdir -p "$REPORT_DIR"
        docker pull opensecurity/njsscan
        docker run --rm -v "${WORKSPACE}:/src" opensecurity/njsscan /src --json | tee "$REPORT_DIR/njsscan-output.json"
        '''
    }
}
```

* Pulls the latest NJSSCAN image.
* Scans the application codebase for vulnerable dependencies.
* Pipes output to `njsscan-output.json`.

---

### 4Ô∏è‚É£ **Upload Scan Results to DefectDojo**

```groovy
stage ('Upload Scan results to DefectDojo') {
    steps {
        sh '''
        curl -X POST "$DEFECTDOJO_URL/api/v2/import-scan/" ...
        '''
    }
}
```

* For each tool:

  * Sends a `POST` request to the DefectDojo API.
  * Includes scan type, engagement ID, file upload, and scan metadata.
  * Automates result ingestion into DefectDojo, where vulnerabilities can be tracked, verified, and triaged.

---

### üìÅ Post-build Actions

```groovy
post {
    always {
        archiveArtifacts artifacts: 'reports/*json', fingerprint: true, allowEmptyArchive: true
    }
}
```

* Archives all generated scan reports for later inspection directly from Jenkins.
* `fingerprint: true` allows tracking report history across builds.

---

---
## JSON Outputs Reference

The tools used in this pipeline generate outputs in JSON format which can be parsed or uploaded to vulnerability management platforms.

| Tool         | Output File                                                  | Description                                |
|--------------|--------------------------------------------------------------|--------------------------------------------|
| **Gitleaks** | [gitleaks-report.json](outputs/gitleaks-report.json) | Detects hardcoded secrets like API keys, tokens, and credentials in code.  |
| **Semgrep**  | [semgrep-report.json](outputs/semgrep-report.json)   | Static analysis tool that identifies code issues, security flaws, and bugs.    |
| **NJSscan** | [njsscan-output.json](outputs/njsscan-output.json) |  Scans Node.js applications for security vulnerabilities in code patterns.  |


---

## üìù Final Notes

* This pipeline can be extended to trigger on PRs, commits, or scheduled scans.
* Future improvements may include:

  * Adding DAST tools like OWASP ZAP
  * Sending notifications on critical findings
  * Integrating with Slack, Jira, or email

---

## üì∏ Screenshots
<img width="1528" alt="Image" src="https://github.com/user-attachments/assets/edf8166e-95b1-4363-825d-24dc3ec05243" /> 

`Successful completion of Jenkins pipeline`

<img width="1528" alt="Image" src="https://github.com/user-attachments/assets/60ca18e3-599d-4f80-8d2f-848797a1a582" />

`Pipeline in action`

<img width="1528" alt="Image" src="https://github.com/user-attachments/assets/90bdb330-a7f0-498c-84b1-ea75637b9f21" />

`Artifacts generated during pipeline run (Outputs in JSON format)`

<img width="1528" alt="Image" src="https://github.com/user-attachments/assets/43a4ea36-068a-420a-bec7-fe434e6356bb" />

`Scan results uploaded to DefectDojo via its REST API`

<img width="1528" alt="Image" src="https://github.com/user-attachments/assets/7b0101df-5c6e-483e-97ea-30389a3911e1" />

`Semgrep Scan Results on DefectDojo`

<img width="1440" alt="Image" src="https://github.com/user-attachments/assets/d7c2c77d-3822-4246-a65b-a074a21ade88" />

`GitLeaks Scan Results on DefectDojo`

---

## üôå Credits

* [OWASP Juice Shop](https://github.com/juice-shop/juice-shop)
* [Gitleaks](https://github.com/gitleaks/gitleaks)
* [Semgrep](https://github.com/semgrep/semgrep)
* [NJSSCAN](https://github.com/ajinabraham/njsscan)
* [DefectDojo](https://demo.defectdojo.org)

---

## üß† License

This project is for educational and ethical use only. MIT License applies.

